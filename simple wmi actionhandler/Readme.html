<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>A simple WMI-based ActionHandler for Windows nodes</title>
	<meta name="author" content="Marcus Klemm"/>
	<meta name="date" content="December 7, 2015"/>
	<link type="text/css" rel="stylesheet" href="https://tabtab.co/css/tabtab.css"/>
	<link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700|Source+Code+Pro|Handlee"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/highlight.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/languages/yaml.min.js"></script>
<script type="text/javascript">hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">window.addEventListener("load", function () { document.body.className = "markdown-view"; }, false);</script>
	<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/styles/github.min.css"/>
<style>body { margin: 1cm !important; }</style>
</head>
<body>

<h1 id="simpleactionhandlertoexecutecommandsonwindowsmachinesusingwmi">Simple ActionHandler to execute commands on Windows machines using WMI</h1>

<p>This guide shows how to install everything from scratch. If you don&#8217;t have an internet connection, all necessary files are included in the &#8220;downloads&#8221; folder. The impacket library has my patch already applied, so you can skip this step.</p>

<h2 id="installtherequiredpackages">Install the required packages</h2>

<h3 id="downloadandinstalltherepoforgerepository:">Download and install the RepoForge repository:</h3>

<p>The version of python-crypto in the standard CentOS 6 repository is too old, so I&#8217;m using the one from RepoForge:</p>

<pre><code class="bash">wget http://pkgs.repoforge.org/rpmforge-release/rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm
yum localinstall rpmforge-release-0.5.3-1.el6.rf.x86_64.rpm
</code></pre>

<h3 id="installthepackages:">Install the packages:</h3>

<pre><code class="bash">yum install --enablerepo=rpmforge-extras` python-crypto python-pyasn1 unix2dos dos2unix
</code></pre>

<h2 id="downloadandinstalltheimpacketpythonlibrary:">Download and install the impacket python library:</h2>

<h3 id="checkoutthelatestversion:">Checkout the latest version:</h3>

<pre><code class="bash">git clone https://github.com/CoreSecurity/impacket.git
</code></pre>

<h3 id="patchthewmiexec.pyscripttosupportthe-quietoptionandremovethebanneraswellastheinteractivewarning:">Patch the wmiexec.py script to support the &#8220;-quiet&#8221; option and remove the banner as well as the interactive warning:</h3>

<pre><code class="bash">patch -i wmiexec.patch impacket/examples/wmiexec.py
</code></pre>

<h3 id="buildandinstall:">Build and install:</h3>

<pre><code class="bash">cd impacket
python setup.py install
</code></pre>

<h2 id="addtheactionhandlerdefinition">Add the ActionHandler definition</h2>

<p>Add the following definition to your /opt/autopilot/conf/aae.yaml file:</p>

<pre><code class="yaml"># WMI based remote execution
- Applicability:
    Priority: 70
    ModelFilter:
      AttributeFilter:
        Name: NodeType
        Mode: string
        Value: Machine
      AttributeFilter:
        Name: MachineClass
        Mode: string
        Value: Windows
  Capability:
  - Name: ExecuteCommand
    Description: &quot;execute command on remote host&quot;
    # Explanation:
    #
    # Command is taken from the KI element &quot;Action&quot;. An additional command
    # &quot;exit&quot; is appended, so that the remote shell will get terminated
    # after command execution. The resulting command string is written to
    # TEMPFILE.
    #
    # The interpreter line then pipes the command string through unix2dos
    # in order to replace the unix-style linefeeds with their DOS
    # counterpart. This is necessary for cmd.exe to recognize them as
    # &quot;Return&quot;.
    #
    # The command is then fed into wmiexec, which takes care of creating a
    # new shell process on the target machine as well as fetching the
    # output via the SMB protocol.
    #
    # The output is then converted back to unix-style linefeeds and UTF8
    # encoding (cmd.exe uses CP437 or CP850 depending on the system
    # language).
    #
    # Last step is to strip an escape sequence that is introduced due to a
    # bug in some python library as well as the leading cmd.exe prompts
    # from the output.
    Interpreter: &lt;${TEMPFILE} unix2dos | wmiexec.py -quiet ${User}:${Password}@${Hostname} 2&gt;/dev/null | dos2unix | iconv -f CP850 -t UTF-8 | sed 's|\x1b\[[?]1034h||g' | sed 's|^[A-Z]:\\[^&gt;]*&gt;||g'
    Command: |
      ${Command}
      exit
    Parameter:
    - Name: Command
      Description: &quot;command to execute&quot;
      Mandatory: true
    - Name: Hostname
      Description: &quot;host to execute command on&quot;
      Mandatory: true
    - Name: User
      Description: &quot;target user&quot;
      Default: vagrant
    - Name: Password
      Description: &quot;target user's password&quot;
      Default: vagrant
</code></pre>

<p>Replace User and Password according to the environment. You can also reference attributes from MARS, please see the section <a href="https://autopilot.co/docs/5.2.1/html/content/5.2-connectors-generic-actionhandler.html#dynamic_values">Dynamic values</a> from the Generic ActionHandler documentation.</p>

<p>Impacket&#8217;s WMI implementation seems to support Kerberos authentification as well, but I have not tried it, yet.</p>

</body>
</html>
